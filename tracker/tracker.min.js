
(function(c,a){T={version:"0.0.1",isSmallScreen:(screen.width>500)?false:true,options:{mode:"",ws:"",watch:{timeout:180000,maximumAge:190000,enableHighAccuracy:true},track:{minDistance:20,multiplier:0.5}},locale:{itsmeId:"It's me."},locations:[],icons:{},map:undefined};c.T=T;T.update=function(f,e){for(var d in e){if(d in f){f[d]=e[d]}}return f};T.parseOptions=function(d){T.options.mode=d.mode;T.options.ws=d.ws;if("watch" in d){var e=(d.watch+"::").split(":");if(parseInt(e[0])){this.options.watch.timeout=parseInt(e[0])*1000}if(parseFloat(e[1])){this.options.watch.maximumAge=parseFloat(e[1])*1000}if(e[2]==="t"){this.options.watch.enableHighAccuracy=true}if(e[2]==="f"){this.options.watch.enableHighAccuracy=false}}if("track" in d){var e=(d.track+":").split(":");if(parseInt(e[0])){this.options.track.minDistance=parseInt(e[0])}if(parseFloat(e[1])){this.options.track.multiplier=parseFloat(e[1])}}};T.latLng=function(d){if(Array.isArray(d.latlng)){d.latlng={lat:d.latlng[0],lng:d.latlng[1]}}else{if("latitude" in d&&"longitude" in d){d.latlng={lat:d.latitude,lng:d.longitude}}}return d};T.makeIcon=function(d,e){e=e||32;return L.icon({iconSize:[e,e],iconAnchor:[e/2,e],iconUrl:d})};T.icons.own=T.makeIcon("./images/phone_y.png");T.icons.active=T.makeIcon("./images/phone_b.png");T.wakeLocker={wakeLock:null,request:null,create:function(){if("getWakeLock" in navigator){for(var d in ["system","screen"]){try{this.wakeLock=navigator.getWakeLock(d);this.wakeLockRequest=this.createRequest();a.addEventListener("visibilitychange",this.createRequest);a.addEventListener("fullscreenchange",this.createRequest);exit}catch(f){console.log(f.message)}}}},createRequest:function(){var d=T.wakeLocker;if(d.wakeLock&&a.visibilityState==="visible"){d.request=d.wakeLock.createRequest()}},cancelRequest:function(){if(T.wakeLocker.request){T.wakeLocker.request.cancel()}}};T.Location=function(){this.id="";this.itsme=false;this.latlng=undefined;this.accuracy=null;this.speed=null;this.altitude=null;this.heading=null;this.timestamp=null;this.timeout=null};T.locationWatcher={watchId:undefined,start:function(f,e,d){if(!("geolocation" in navigator)){e({code:0,message:"Geolocaton: not supported."});return}if(this.watchId){this.stop()}this.lastLocation=undefined;this.isFree=true;this.locations=[];this.onLocationFound=f;this.watchId=navigator.geolocation.watchPosition(function(h){var m=T.locationWatcher;if(!m.lastLocation){m.lastLocation=h;m.locations.push(h);m.onLocationFound(h)}else{m.locations.push(h);if(m.locations.length>2&&m.isFree){m.isFree=false;var o=0,p=0,n=0,j=0,q=0,g;for(var k=0;k<3;k++){g=m.locations.shift();o+=g.coords.latitude;p+=g.coords.longitude;j=Math.max(j,g.coords.accuracy);n+=g.coords.altitude;q=Math.max(q,g.timestamp)}g.coords.latitude=o/3;g.coords.longitude=p/3;g.coords.altitude=n/3;g.coords.accuracy=j;g.timestamp=q;m.lastLocation=g;m.isFree=true}m.onLocationFound(m.lastLocation)}},e,d)},stop:function(){if(this.watchId){navigator.geolocation.clearWatch(this.watchId);this.watchId=undefined}}};T.onLocationFound=function(d){var e=new T.Location();T.update(e,T.latLng(d.coords));e.id=T.locale.itsmeId;e.itsme=true;e.timestamp=d.timestamp;e.timeout=T.options.watch.timeout;T.onLocation(e)};T.onLocationError=function(d){d.message="Geolocation: "+d.message;console.log(d.message);T.map.consolePane.log(d.message)};T.onLocation=function(d){if(!this.map.isLoaded&&this.locations.length===0){this.map.setView(d.latlng,this.map.options.zoom)}if(!this.locations[d.id]){this.locations[d.id]=d}this.map.setMarker(d)};T.actions=[];T.actions.location=function(d){T.onLocation(d)};T.actions.message=function(d){T.map.consolePane.log(d.message)};T.onAction=function(d){var e=T.actions[d.action];if(e){e(d)}};T.onJSONMessage=function(e){var d=JSON.parse(e);T.onAction(d)};T.checkWebSocket=function(){if(this.options.ws){var f=(c.location.protocol==="https:"?"wss://":"ws://")+this.options.ws;try{if("webSocket" in T){T.webSocket.close()}T.webSocket=new WebSocket(f);T.webSocket.onmessage=T.onJSONMessage;T.webSocket.onopen=function(g){T.sendMessage=function(e){T.webSocket.send(e)};console.log("WebSocket open")};T.webSocket.onclose=function(g){console.log("WebSocket close")};T.webSocket.onerror=function(g){T.map.consolePane.log(g.message);console.log(g.message)}}catch(d){console.log(d.message)}}};T.checkMode=function(d){return((new RegExp("(^|,)"+d+"(,|$)","i")).test(this.options.mode))};T.checkWatchMode=function(){if(!this.checkMode("nowatch")){this.locationWatcher.start(T.onLocationFound,T.onLocationError,T.options.watch);this.wakeLocker.create()}};T.checkDemoMode=function(d){if(this.checkMode("demo")){this.demo.run(5000,d)}};T.expirationTimer;T.checkExpiredLocations=function(){if(!this.expirationTimer){this.expirationTimer=setInterval(function(){for(var d in T.locations){if(T.locations[d].timestamp+T.locations[d].timeout<Date.now()){T.map.setMarkerOpacity(T.locations[d],0.4)}}},60000)}};T.run=function(e,d,f){this.parseOptions(e);this.map=this._map(d).load(f);this.checkWebSocket();this.checkWatchMode();this.checkExpiredLocations()};T._map=function(d,f){var e=L.map(d,{minZoom:10,zoom:17,zoomControl:false});L.tileLayer(c.location.protocol+"//{s}.tile.osm.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'}).addTo(e);T.UI.addTo(e);e.isLoaded=false;e.accuracyLayer=L.featureGroup();e.addLayer(e.accuracyLayer);e.showAccuracy=true;e.toggleAccuracy=function(){this.showAccuracy=!this.showAccuracy;if(this.showAccuracy){if(!e.hasLayer(this.track.accuracyLayer)){this.addLayer(this.track.accuracyLayer)}this.addLayer(this.accuracyLayer)}else{if(e.hasLayer(this.track.accuracyLayer)){this.removeLayer(this.track.accuracyLayer)}this.removeLayer(this.accuracyLayer)}return this.showAccuracy};e.markers=[];e.boundMarkers=function(){var h=null;for(var g in this.markers){if(!h){h=this.markers[g].accuracyCircle.getBounds()}else{h=h.extend(this.markers[g].accuracyCircle.getBounds())}}if(h){this.fitBounds(h)}};e.track={marker:undefined,pathLayer:undefined,accuracyLayer:L.featureGroup(),pathLength:0,lastLocation:undefined,rubberThread:undefined};e.track.init=function(g){if(g.hasLayer(this.accuracyLayer)){g.removeLayer(this.accuracyLayer)}if(g.hasLayer(this.pathLayer)){g.removeLayer(this.pathLayer)}this.pathLayer=L.polyline([],{weight:2,color:"red"}).addTo(g);this.rubberThread=L.polyline([],{weight:2,color:"red"}).addTo(g);this.accuracyLayer=L.featureGroup();if(g.showAccuracy){g.addLayer(this.accuracyLayer)}this.pathLength=0;this.lastLocation=undefined};e.startTrack=function(g){if(this.track.marker===g){this.track.marker=undefined;this.track.rubberThread.setLatLngs([]);if(this.infoPane){this.infoPane.remove()}}else{this.track.init(this);this.track.started=g.location.timestamp;if(!this.infoPane){T.UI.infoPane.addTo(this)}this.track.marker=g;this.trackMarker(g)}};e.onMarkerClick=function(h){var i=h.target.options.alt;var g=this.markers[i];this.startTrack(g)};e.trackMarker=function(g){if(this.track.marker===g){var i=0;var h=T.options.track.minDistance;if(this.track.lastLocation){i=e.distance(g.location.latlng,this.track.lastLocation.latlng);h=Math.max(h,h*T.options.track.multiplier*i*1000/(g.location.timestamp-this.track.lastLocation.timestamp))}if(!this.track.lastLocation||i>=h){this.track.lastLocation=g.location;this.track.pathLayer.addLatLng(g.location.latlng);L.circle(g.location.latlng,g.accuracyCircle.getRadius(),{weight:1,color:"blue"}).addTo(this.track.accuracyLayer);this.track.pathLength+=i;this.track.rubberThread.setLatLngs([])}else{this.track.rubberThread.setLatLngs([this.track.lastLocation.latlng,g.location.latlng])}this.setView(g.location.latlng,this.getZoom());this.infoPane.update(L.Util.extend(g.location,{trackLength:this.track.pathLength,trackTime:g.location.timestamp-this.track.started,movement:i}))}};e.setMarkerOpacity=function(i,h){var g=this.markers[i.id];if(g){g.setOpacity(h)}};e.setMarker=function(i,h){h=h||(i.itsme?T.icons.own:T.icons.active);var g=this.markers[i.id];if(!g){g=L.marker(i.latlng,{icon:h,alt:i.id});g.on("click",function(j){e.onMarkerClick(j)});g.addTo(this);g.accuracyCircle=L.circle(i.latlng,i.accuracy,{weight:1,color:"blue"}).addTo(this.accuracyLayer);this.markers[i.id]=g}else{g.setLatLng(i.latlng);g.accuracyCircle.setLatLng(i.latlng);g.accuracyCircle.setRadius(i.accuracy);g.setOpacity(1)}g.location=i;this.trackMarker(g);return g};e.load=function(g){this.on("load",function(h){e.isLoaded=true});this.on("locationfound",function(h){e.consolePane.log();e.setView(h.latlng,this.options.zoom);T.checkDemoMode(h.latlng)});this.on("locationerror",function(h){T.checkDemoMode();this.consolePane.log(h.message);console.log(h.message)});this.locateOwn(g);return this};e.locateOwn=function(g){if(g){this.setView(g,this.options.zoom)}else{this.consolePane.log("Expect location...",120000);this.locate({setView:false})}return this};return e};T.UI={infoPane:new (L.Control.extend({options:{position:"bottomleft",infoData:{id:{nick:"Track: ",unit:""},trackLength:{nick:"DST",unit:"m"},trackTime:{nick:"TTM",unit:""},timestamp:{nick:"TME",unit:""},speed:{nick:"SPD",unit:"m/sec"},altitude:{nick:"ALT",unit:"m"},movement:{nick:"MVT",unit:"m"},heading:{nick:"HDN",unit:"&deg"},accuracy:{nick:"ACC",unit:"m"}}},onAdd:function(g){var j=L.DomUtil.create("div","tracker-pane"),f,i,h,e;j.onclick=function(k){var l=g.infoPane.getContainer();if(!l.style.marginLeft){l.style.marginLeft="-120px"}else{l.style.marginLeft=""}};e=L.DomUtil.create("div","tracker-info-header",j);this.options.infoData.id.element=e;f=L.DomUtil.create("table","tracker-info-table",j);e=L.DomUtil.create("div","tracker-info-header",j);e.innerHTML="Location:";i=L.DomUtil.create("table","tracker-info-table",j);for(var d in this.options.infoData){if(d==="id"){continue}if(d==="timestamp"){f=i}h=L.DomUtil.create("tr","tracker-info-row",f);e=L.DomUtil.create("td","tracker-info-nick",h);e.innerHTML=this.options.infoData[d].nick;e=L.DomUtil.create("td","tracker-info-value",h);this.options.infoData[d].element=e}g.infoPane=this;return j},onRemove:function(d){delete d.infoPane},update:function(f){for(var d in this.options.infoData){if(!(d in f)){continue}var e=f[d];switch(d){case"id":e=this.options.infoData[d].nick+e;break;case"timestamp":e=(new Date(e)).toTimeString().substring(0,8);break;case"trackTime":e=(new Date(e)).toISOString().substring(11,19);break;default:e=Math.round(e).toString()}this.options.infoData[d].element.innerHTML=e+" "+this.options.infoData[d].unit}}})),consolePane:new (L.Control.extend({options:{position:"bottomright",element:undefined},onAdd:function(d){var e=L.DomUtil.create("div","tracker-pane");this.options.element=e;L.DomUtil.create("div","tracker-console-message",e);e.hidden=true;d.consolePane=this;return e},onRemove:function(d){delete d.consolePane},log:function(d,e){if(d){this.options.element.childNodes[0].innerHTML=(new Date()).toTimeString().substring(0,8)+" "+d;this.options.element.hidden=false;e=e?e:10000;this.options.timer=setTimeout(function(f){f.hidden=true},e,this.options.element)}else{this.options.element.hidden=true}}})),controlPane:new (L.Control.extend({options:{position:"topright",buttons:{btnSearch:{img:"./images/btn_search.png",onclick:function(d){return(function(h){var g=this.getElementsByClassName("tracker-search")[0];if(!g){g=L.DomUtil.create("form","tracker-search");var f=L.DomUtil.create("input","tracker-search",g);f.type="text";f.name="searchCriteria";g.onsubmit=function(){d.consolePane.log(this.searchCriteria.value);this.parentElement.removeChild(g);return false};this.insertBefore(g,h.target);f.focus()}else{g.dispatchEvent(new Event("submit"))}})}},btnAccuracy:{img:"./images/btn_accuracy.png",onclick:function(d){return(function(f){this.childNodes[1].hidden=!d.toggleAccuracy()})},checked:true},btnBound:{img:"./images/btn_bound.png",onclick:function(d){return(function(f){d.boundMarkers()})}},btnLocate:{img:"./images/btn_locate.png",onclick:function(d){return(function(f){d.locateOwn()})}}}},onAdd:function(g){var i=L.DomUtil.create("div","tracker-buttons-pane"),h,f,d;for(var e in this.options.buttons){h=L.DomUtil.create("div","tracker-button",i);f=L.DomUtil.create("img","tracker-button",h);f.src=this.options.buttons[e].img;if(this.options.buttons[e].onclick){h.onclick=this.options.buttons[e].onclick(g)}if("checked" in this.options.buttons[e]){d=L.DomUtil.create("img","tracker-button-checker",h);d.src="./images/btn_checker.png";d.hidden=!this.options.buttons[e].checked}}return i},onRemove:function(d){}})),searchById:function(e){e="^"+e.replace("%",".+").replace("*",".*")+"^";var d=[];var g=new RegExp(e,"i");for(var f in this.markers){if(g.test(this.markers[f])){d.push(this.markers[f])}}return d},addTo:function(d){this.controlPane.addTo(d);(new (L.Control.extend({options:{position:"topright"},onAdd:function(e){var f=L.DomUtil.create("div","tracker-pane");f.hidden=true;e.listPane=this;return f},onRemove:function(e){}}))).addTo(d);this.consolePane.addTo(d)}};var b=function(d){create=function(e){};fill=function(e){}};c.addEventListener("unload",function(){T.locationWatcher.stop();if("webSocket" in T){T.webSocket.close()}clearTimeout(T.expirationTimer)});T.demo={isRunning:false,demos:[],randInt:function(e,d){if(e===d){return e}return Math.floor((Math.random()*(d-e+1))+e)},randDbl:function(e,d){if(e===d){return e}return(Math.random()*(d-e))+e},radialDistance:function(f,o,e){var g=6371010;var j=e;var n=Math.PI/180;var h=(o%360)*n;var m=f.lat*n;var k=f.lng*n;var l=Math.asin((Math.sin(m)*Math.cos(j/g))+(Math.cos(m)*Math.sin(j/g)*Math.cos(h)));var i=k+Math.atan2(Math.sin(h)*Math.sin(j/g)*Math.cos(m),Math.cos(j/g)-Math.sin(m)*Math.sin(l));return{lat:l/n,lng:((i/n)+540)%360-180}},moveRandom:function(d){d.heading=this.randDbl(0,180);var e=this.randDbl(10,50);d.latlng=this.radialDistance(d.latlng,d.heading,e);d.speed=e/((Date.now()-d.timestamp)/1000);d.accuracy=this.randDbl(5,50);d.timestamp=Date.now();return d},sendAllDemos:function(){for(var d=0;d<this.demos.length;d++){this.sendDemo(this.moveRandom(this.demos[d]))}},sendDemo:function(e){T.onJSONMessage(JSON.stringify(e))},run:function(d,g){if(this.isRunning){return}this.isRunning=true;for(var e=0;e<5;e++){var f=new T.Location();f.action="location";f.id="Demo "+(e+1);f.timeout=d;f.latlng=g?g:L.latLng(51.505,-0.09);this.demos[e]=this.moveRandom(f)}this.sendAllDemos();setInterval(function(h){h.sendAllDemos()},d,this);T.onJSONMessage(JSON.stringify({action:"message",message:"DEMO started"}))}}}(window,document));