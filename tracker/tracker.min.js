
(function(b,a){T={version:"0.0.1",isSmallScreen:(screen.width>500)?false:true,options:{mode:"",ws:"",watch:{timeout:180000,maximumAge:190000,enableHighAccuracy:true},track:{minDistance:20,multiplier:0.5}},locale:{itsmeId:"It's me."},locations:[],icons:{},map:undefined};b.T=T;T.update=function(e,d){for(var c in d){if(c in e){e[c]=d[c]}}return e};T.parseOptions=function(c){this.update(T.options,c);if("watch" in c){var d=(c.watch+"::").split(":");if(parseInt(d[0])){this.options.watch.timeout=parseInt(d[0])*1000}if(parseFloat(d[1])){this.options.watch.maximumAge=parseFloat(d[1])*1000}if(d[2]==="t"){this.options.watch.enableHighAccuracy=true}if(d[2]==="f"){this.options.watch.enableHighAccuracy=false}}if("track" in c&&parseInt(c.track)){var d=(c.track+":").split(":");if(parseInt(d[0])){this.options.track.minDistance=parseInt(d[0])}if(parseFloat(d[1])){this.options.track.multiplier=parseFloat(d[1])}}};T.latLng=function(c){if(Array.isArray(c.latlng)){c.latlng={lat:c.latlng[0],lng:c.latlng[1]}}else{if("latitude" in c&&"longitude" in c){c.latlng={lat:c.latitude,lng:c.longitude}}}return c};T.makeIcon=function(c,d){d=d||32;return L.icon({iconSize:[d,d],iconAnchor:[d/2,d],iconUrl:c})};T.icons.own=T.makeIcon("./images/phone_y.png");T.icons.active=T.makeIcon("./images/phone_b.png");T.Location=function(){this.id="";this.itsme=false;this.latlng=undefined;this.accuracy=NaN;this.speed=NaN;this.altitude=NaN;this.heading=NaN;this.timestamp=NaN;this.timeout=NaN};T.onLocationFound=function(c){var d=new T.Location();T.update(d,T.latLng(c.coords));d.id=T.locale.itsmeId;d.itsme=true;d.timestamp=c.timestamp;d.timeout=T.options.watch.timeout;T.onLocation(d)};T.onLocationError=function(c){c.message="Geolocation: "+c.message;console.log(c.message);T.map.consolePane.log(c.message)};T.geoLocator={watchId:undefined,start:function(e,d,c){if(!("geolocation" in navigator)){d({code:0,message:"Geolocaton: not supported."});return}if(this.watchId){this.stop()}this.lastLocation=undefined;this.isFree=true;this.locations=[];this.onLocationFound=e;this.watchId=navigator.geolocation.watchPosition(function(f){var o=T.geoLocator;if(!o.lastLocation){o.lastLocation=f;o.locations.push(f);o.onLocationFound(f)}else{if(o.lastLocation.timestamp>f.timestamp){return}o.locations.push(f);if(o.locations.length>2&&o.isFree){o.isFree=false;var n=0,g=0,m=0,j=0,k;for(var h=0;h<3;h++){k=o.locations.pop();n+=k.coords.latitude;g+=k.coords.longitude;j=Math.max(j,k.coords.accuracy);m+=k.coords.altitude}k.coords.latitude=n/3;k.coords.longitude=g/3;k.coords.altitude=m/3;k.coords.accuracy=j;o.lastLocation=k;o.isFree=true}o.onLocationFound(o.lastLocation)}},d,c)},stop:function(){if(this.watchId){navigator.geolocation.clearWatch(this.watchId);this.watchId=undefined}}};T.onLocation=function(c){if(!this.map.isLoaded&&this.locations.length===0){this.map.setView(c.latlng,this.map.options.zoom)}if(!this.locations[c.id]){this.locations[c.id]=c}this.map.setMarker(c)};T.actions=[];T.actions.location=function(c){T.onLocation(c)};T.actions.message=function(c){T.map.consolePane.log(c.message)};T.onMessage=function(d){var c=JSON.parse(d);var e=T.actions[c.action];if(e){e(c)}};T.checkWebSocket=function(){if(this.options.ws){var d=(b.location.protocol==="https:"?"wss://":"ws://")+this.options.ws;try{T.webSocket=new WebSocket(d);T.webSocket.onmessage=T.onMessage;T.webSocket.onopen=function(f){T.sendMessage=function(e){T.webSocket.send(e)};console.log("WebSocket open")};T.webSocket.onclose=function(f){console.log("WebSocket close")};T.webSocket.onerror=function(f){T.map.consolePane.log(f.message);console.log(f.message)}}catch(c){console.log(c.message)}}};T.testMode=function(c){return((new RegExp("(^|,)"+c+"(,|$)","i")).test(this.options.mode))};T.checkWatchMode=function(){if(!this.testMode("nowatch")){this.geoLocator.start(T.onLocationFound,T.onLocationError,T.options.watch);if("getWakeLock" in navigator){navigator.getWakeLock("system").then(function(c){T.wakeLockRequest=c.createRequest()})}else{T.map.consolePane.log("WakeLock not allowed")}}};T.checkDemoMode=function(c){if(this.testMode("demo")){this.demo.run(5000,c)}};T.expirationTimer;T.checkExpiredLocations=function(){if(!this.expirationTimer){this.expirationTimer=setInterval(function(){for(var c in T.locations){if(T.locations[c].timestamp+T.locations[c].timeout<Date.now()){T.map.setMarkerOpacity(T.locations[c],0.4)}}},60000)}};T.run=function(d,c,e){this.parseOptions(d);this.map=this._map(c).load(e);this.checkWebSocket();this.checkWatchMode();this.checkExpiredLocations()};T._map=function(c,e){var d=L.map(c,{minZoom:5,zoom:17,zoomControl:false});L.tileLayer(b.location.protocol+"//{s}.tile.osm.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'}).addTo(d);T.UI.addTo(d);d.isLoaded=false;d.accuracyLayer=L.featureGroup();d.addLayer(d.accuracyLayer);d.showAccuracy=true;d.toggleAccuracy=function(){this.showAccuracy=!this.showAccuracy;if(this.showAccuracy){if(!d.hasLayer(this.track.accuracyLayer)){this.addLayer(this.track.accuracyLayer)}this.addLayer(this.accuracyLayer)}else{if(d.hasLayer(this.track.accuracyLayer)){this.removeLayer(this.track.accuracyLayer)}this.removeLayer(this.accuracyLayer)}return this.showAccuracy};d.markers=[];d.boundMarkers=function(){var h=[];for(var f in this.markers){h.push(this.markers[f].getLatLng())}if(h.length>0){var g=L.latLngBounds(h);this.fitBounds(g);this.setView(g.getCenter())}};d.track={marker:undefined,pathLayer:undefined,accuracyLayer:L.featureGroup(),pathLength:0,lastLocation:undefined,rubberThread:undefined};d.track.init=function(f){if(f.hasLayer(this.accuracyLayer)){f.removeLayer(this.accuracyLayer)}if(f.hasLayer(this.pathLayer)){f.removeLayer(this.pathLayer)}this.pathLayer=L.polyline([],{weight:2,color:"red"}).addTo(f);this.rubberThread=L.polyline([],{weight:2,color:"red"}).addTo(f);this.accuracyLayer=L.featureGroup();if(f.showAccuracy){f.addLayer(this.accuracyLayer)}this.pathLength=0;this.lastLocation=undefined};d.onMarkerClick=function(g){var h=g.target.options.alt;var f=this.markers[h];if(this.track.marker===f){this.track.marker=undefined;this.track.rubberThread.setLatLngs([]);if(this.infoPane){this.infoPane.remove()}}else{this.track.init(this);this.track.started=f.location.timestamp;if(!this.infoPane){T.UI.infoPane.addTo(this)}this.track.marker=f;this.trackMarker(f)}};d.trackMarker=function(f){if(this.track.marker===f){var h=0;var g=T.options.track.minDistance;if(this.track.lastLocation){h=d.distance(f.location.latlng,this.track.lastLocation.latlng);g=Math.max(g,g*T.options.track.multiplier*f.location.speed)}if(!this.track.lastLocation||h>=g){this.track.lastLocation=f.location;this.track.pathLayer.addLatLng(f.location.latlng);L.circle(f.location.latlng,f.accuracyCircle.getRadius(),{weight:1,color:"blue"}).addTo(this.track.accuracyLayer);this.track.pathLength+=h;this.track.rubberThread.setLatLngs([])}else{this.track.rubberThread.setLatLngs([this.track.lastLocation.latlng,f.location.latlng])}this.setView(f.location.latlng,this.getZoom());this.infoPane.update(L.Util.extend(f.location,{trackLength:this.track.pathLength,trackTime:f.location.timestamp-this.track.started,movement:h}))}};d.setMarkerOpacity=function(h,g){var f=this.markers[h.id];if(f){f.setOpacity(g)}};d.setMarker=function(h,g){g=g||(h.itsme?T.icons.own:T.icons.active);var f=this.markers[h.id];if(!f){f=L.marker(h.latlng,{icon:g,alt:h.id});f.on("click",function(i){d.onMarkerClick(i)});f.addTo(this);f.accuracyCircle=L.circle(h.latlng,h.accuracy,{weight:1,color:"blue"}).addTo(this.accuracyLayer);this.markers[h.id]=f}else{f.setLatLng(h.latlng);f.accuracyCircle.setLatLng(h.latlng);f.accuracyCircle.setRadius(h.accuracy);f.setOpacity(1)}f.location=h;this.trackMarker(f);return f};d.load=function(f){this.on("load",function(g){d.isLoaded=true});this.on("locationfound",function(g){d.consolePane.log();d.setView(g.latlng,this.options.zoom);T.checkDemoMode(g.latlng)});this.on("locationerror",function(g){T.checkDemoMode();this.consolePane.log(g.message);console.log(g.message)});this.locateOwn(f);return this};d.locateOwn=function(f){if(f){this.setView(f,this.options.zoom)}else{this.consolePane.log("Expect location...",120000);this.locate({setView:false})}return this};return d};T.UI={infoPane:new (L.Control.extend({options:{position:"bottomleft",infoData:{id:{nick:"Track: ",unit:""},trackLength:{nick:"DST",unit:"m"},trackTime:{nick:"TTM",unit:""},timestamp:{nick:"TME",unit:""},speed:{nick:"SPD",unit:"m/sec"},altitude:{nick:"ALT",unit:"m"},movement:{nick:"MVT",unit:"m"},heading:{nick:"HDN",unit:"&deg"},accuracy:{nick:"ACC",unit:"m"}}},onAdd:function(f){var i=L.DomUtil.create("div","tracker-pane"),e,h,g,d;i.onclick=function(j){var k=f.infoPane.getContainer();if(!k.style.marginLeft){k.style.marginLeft="-120px"}else{k.style.marginLeft=""}};d=L.DomUtil.create("div","tracker-info-header",i);this.options.infoData.id.element=d;e=L.DomUtil.create("table","tracker-info-table",i);d=L.DomUtil.create("div","tracker-info-header",i);d.innerHTML="Location:";h=L.DomUtil.create("table","tracker-info-table",i);for(var c in this.options.infoData){if(c==="id"){continue}if(c==="timestamp"){e=h}g=L.DomUtil.create("tr","tracker-info-row",e);d=L.DomUtil.create("td","tracker-info-nick",g);d.innerHTML=this.options.infoData[c].nick;d=L.DomUtil.create("td","tracker-info-value",g);this.options.infoData[c].element=d}f.infoPane=this;return i},onRemove:function(c){delete c.infoPane},update:function(e){for(var c in this.options.infoData){if(!(c in e)){continue}var d=e[c];switch(c){case"id":d=this.options.infoData[c].nick+d;break;case"timestamp":d=(new Date(d)).toTimeString().substring(0,8);break;case"trackTime":d=(new Date(d)).toISOString().substring(11,19);break;default:d=Math.round(d).toString()}this.options.infoData[c].element.innerHTML=d+" "+this.options.infoData[c].unit}}})),consolePane:new (L.Control.extend({options:{position:"bottomright",element:undefined},onAdd:function(c){var d=L.DomUtil.create("div","tracker-pane");this.options.element=d;L.DomUtil.create("div","tracker-console-message",d);d.hidden=true;c.consolePane=this;return d},onRemove:function(c){delete c.consolePane},log:function(c,d){if(c){this.options.element.childNodes[0].innerHTML=(new Date()).toTimeString().substring(0,8)+" "+c;this.options.element.hidden=false;d=d?d:10000;this.options.timer=setTimeout(function(f){f.hidden=true},d,this.options.element)}else{this.options.element.hidden=true}}})),controlPane:new (L.Control.extend({options:{position:"topright",buttons:{btnSearch:{img:"./images/btn_search.png",onclick:function(c){return(function(g){var f=g.target.parentNode.getElementsByClassName("tracker-search-pane")[0];if(!f){f=L.DomUtil.create("form","tracker-search-pane");var d=L.DomUtil.create("input","tracker-search-pane",f);d.type="text";d.name="searchCriteria";f.onsubmit=function(){c.consolePane.log(this.searchCriteria.value);return false};d.onchange=function(){c.consolePane.log(this.value)};g.target.parentNode.insertBefore(f,g.target);d.focus()}else{g.target.parentNode.removeChild(f)}})}},btnAccuracy:{img:"./images/btn_accuracy.png",onclick:function(c){return(function(d){d.target.parentElement.childNodes[1].hidden=!c.toggleAccuracy()})},checked:true},btnBound:{img:"./images/btn_bound.png",onclick:function(c){return(function(d){c.boundMarkers()})}},btnLocate:{img:"./images/btn_locate.png",onclick:function(c){return(function(d){c.locateOwn()})}}}},onAdd:function(f){var h=L.DomUtil.create("div","tracker-buttons-pane"),g,e,c;for(var d in this.options.buttons){g=L.DomUtil.create("div","tracker-button",h);e=L.DomUtil.create("img","tracker-button",g);e.src=this.options.buttons[d].img;if(this.options.buttons[d].onclick){e.onclick=this.options.buttons[d].onclick(f)}if("checked" in this.options.buttons[d]){c=L.DomUtil.create("img","tracker-button-checker",g);c.src="./images/btn_checker.png";c.hidden=!this.options.buttons[d].checked}}return h},onRemove:function(c){}})),searchPane:new (L.Control.extend({options:{position:"topright",element:undefined},onAdd:function(e){var d=L.DomUtil.create("form","tracker-search-pane");var c=L.DomUtil.create("input","tracker-search-pane",d);c.type="text";c.name="search";c.onchange=function(){};d.onsubmit=function(){return false};e.searchPane=this;return d},onRemove:function(c){delete c.searchPane}})),addTo:function(c){this.consolePane.addTo(c);this.controlPane.addTo(c)}};b.addEventListener("unload",function(){T.geoLocator.stop();if("webSocket" in T){T.webSocket.close()}clearTimeout(T.expirationTimer)});T.demo={isRunning:false,demos:[],randInt:function(d,c){if(d===c){return d}return Math.floor((Math.random()*(c-d+1))+d)},randDbl:function(d,c){if(d===c){return d}return(Math.random()*(c-d))+d},radialDistance:function(e,n,c){var f=6371010;var i=c;var m=Math.PI/180;var g=(n%360)*m;var l=e.lat*m;var j=e.lng*m;var k=Math.asin((Math.sin(l)*Math.cos(i/f))+(Math.cos(l)*Math.sin(i/f)*Math.cos(g)));var h=j+Math.atan2(Math.sin(g)*Math.sin(i/f)*Math.cos(l),Math.cos(i/f)-Math.sin(l)*Math.sin(k));return{lat:k/m,lng:((h/m)+540)%360-180}},moveRandom:function(c){c.heading=this.randDbl(0,180);var d=this.randDbl(10,50);c.latlng=this.radialDistance(c.latlng,c.heading,d);c.speed=d/((Date.now()-c.timestamp)/1000);c.accuracy=this.randDbl(5,50);c.timestamp=Date.now();return c},sendAllDemos:function(){for(var c=0;c<this.demos.length;c++){this.sendDemo(this.moveRandom(this.demos[c]))}},sendDemo:function(c){T.onMessage(JSON.stringify(c))},run:function(c,f){if(this.isRunning){return}this.isRunning=true;for(var d=0;d<5;d++){var e=new T.Location();e.action="location";e.id="Demo "+(d+1);e.timeout=c;e.latlng=f?f:L.latLng(51.505,-0.09);this.demos[d]=this.moveRandom(e)}this.sendAllDemos();setInterval(function(g){g.sendAllDemos()},c,this);T.onMessage(JSON.stringify({action:"message",message:"DEMO started"}))}}}(window,document));