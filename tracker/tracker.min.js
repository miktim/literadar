!function(window,document){var prefixes,mq,query;T={version:"0.0.2",options:{mode:"watch",ws:"",watch:{timeout:18e4,maximumAge:12e4,enableHighAccuracy:!0},track:{minDistance:20,multiplier:.5}},locale:{ownId:"Own"},smallScreen:!(Math.min(screen.width,screen.height)>500),touchScreen:(prefixes=" -webkit- -moz- -o- -ms- ".split(" "),mq=function(query){return window.matchMedia(query).matches},!!("ontouchstart"in window||window.DocumentTouch&&document instanceof DocumentTouch)||mq(["(",prefixes.join("touch-enabled),("),"heartz",")"].join(""))),locations:[],icons:{},map:null},window.T=T,T.makeIcon=function(url,isz){return isz=isz||32,L.icon({iconSize:[isz,isz],iconAnchor:[isz/2,isz],iconUrl:url})},T.icons.own=T.makeIcon("./images/phone_y.png"),T.icons.default=T.makeIcon("./images/phone_b.png"),T.update=function(obj,opts){for(var key in opts)key in obj&&(obj[key]=opts[key]);return obj},function(){if(location.search)try{var search=location.search.substring(1),hOptions=JSON.parse('{"'+search.replace(/&/g,'","').replace(/=/g,'":"')+'"}',(function(key,value){return""===key?value:decodeURIComponent(value)}));if(T.options.mode=hOptions.mode?hOptions.mode:T.options.mode,T.options.ws=hOptions.ws?hOptions.ws:T.options.ws,"watch"in hOptions){var val=(hOptions.watch+"::").split(":");parseInt(val[0])&&(T.options.watch.timeout=1e3*parseInt(val[0])),parseFloat(val[1])&&(T.options.watch.maximumAge=1e3*parseFloat(val[1])),"f"===val[2]&&(T.options.watch.enableHighAccuracy=!1)}if("track"in hOptions){var val=(hOptions.track+":").split(":");parseInt(val[0])&&(T.options.track.minDistance=parseInt(val[0])),parseFloat(val[1])&&(T.options.track.multiplier=parseFloat(val[1]))}}catch(e){console.log(e.message)}}(),T.latLng=function(obj){return Array.isArray(obj.latlng)?obj.latlng={lat:obj.latlng[0],lng:obj.latlng[1]}:"latitude"in obj&&"longitude"in obj&&(obj.latlng={lat:obj.latitude,lng:obj.longitude}),obj},T.WakeLocker=function(){if(this.wakeLock=null,!("getWakeLock"in navigator))return console.log("WakeLock API not supported. NoSleep used."),new NoSleep;for(var wlTypes=["system","screen"],i=0;i<2;i++)try{this.wakeLock=navigator.getWakeLock(wlTypes[i]);break}catch(e){console.log(e.message)}this.request=null,this.createRequest=function(){this.wakeLock&&"visible"===document.visibilityState&&(this.request=this.wakeLock.createRequest())},this.handleEvent=function(e){"visibilitychange"!==e.type&&"fullscreenchange"!==e.type||this.createRequest()},this.enable=function(){document.addEventListener("visibilitychange",this),document.addEventListener("fullscreenchange",this),this.createRequest()},this.disable=function(){this.wakeLocker.request&&(document.removeEventListener("visibilitychange",this),document.removeEventListener("fullscreenchange",this),this.request.cancel())}},T.Location=function(){this.id="",this.itsme=!1,this.latlng={},this.accuracy=null,this.speed=null,this.altitude=null,this.altitudeAccuracy=null,this.heading=null,this.timestamp=null,this.timeout=null},T.locationWatcher=new function(){this.watchId,this.start=function(onFound,onError,options){if("geolocation"in navigator){this.watchId&&this.stop(),this.lastLocation,this.isFree=!0,this.locations=[],this.onLocationFound=onFound;var lw=this;this.watchId=navigator.geolocation.watchPosition((function(l){if(lw.lastLocation||(lw.lastLocation=l,lw.onLocationFound(lw.lastLocation)),!(lw.lastLocation.timestamp>l.timestamp)&&(lw.locations.push(l),lw.locations.length>1)){var loc=lw.locations.shift();lw.lastLocation=lw.locations.shift(),loc.coords.accuracy<lw.lastLocation.coords.accuracy&&(lw.lastlocation=loc),lw.onLocationFound(lw.lastLocation)}}),onError,options)}else onError({code:0,message:"Geolocaton API not supported."})},this.stop=function(){this.watchId&&(navigator.geolocation.clearWatch(this.watchId),this.watchId=null)}},T.onLocationFound=function(l){var loc=new T.Location;T.update(loc,T.latLng(l.coords)),loc.id=T.locale.ownId,loc.itsme=!0,loc.timestamp=l.timestamp,loc.timeout=T.options.watch.timeout,T.onLocation(loc)},T.onLocationError=function(e){e.message="Geolocation: "+e.message,console.log(e.message),T.map.ui.consolePane.log("WATCH: "+e.message)},T.onLocation=function(loc){this.map.isLoaded||(this.map.setView(loc.latlng,this.map.options.zoom),this.map.isLoaded=!0),this.locations[loc.id]||(this.locations[loc.id]=loc),this.map.setMarker(loc)},T.actions={},T.actions.location=function(a){T.onLocation(a)},T.actions.message=function(a){T.map.ui.consolePane.log(a.message)},T.actions.answer=function(a){"sendJSONMessage"in T&&T.sendJSONMessage(JSON.stringify(a))},T.onJSONMessage=function(m){try{var actionObj=JSON.parse(m),action=actionObj.action;T.actions[action](actionObj)}catch(e){T.actions.answer({event:"error",action:action,error:e})}},T.checkWebSocket=function(){if(this.options.ws){var wsurl=("https:"===window.location.protocol?"wss://":"ws://")+this.options.ws;try{"webSocket"in T&&T.webSocket.close(),T.webSocket=new WebSocket(wsurl),T.webSocket.onmessage=T.onJSONMessage,T.webSocket.onopen=function(e){T.sendJSONMessage=function(m){T.webSocket.send(m)},console.log("WebSocket open")},T.webSocket.onclose=function(e){console.log("WebSocket close"),delete T.sendJSONMessage},T.webSocket.onerror=function(e){T.map.ui.consolePane.log(e.message),console.log(e.message)}}catch(e){console.log(e.message)}}},T.checkMode=function(mode){return new RegExp("(^|,)"+mode+"(,|$)","i").test(this.options.mode)},T.checkWatchMode=function(){this.checkMode("nowatch")?T.noSleep={enable:function(){},disable:function(){}}:(this.locationWatcher.start(T.onLocationFound,T.onLocationError,T.options.watch),T.noSleep=new T.WakeLocker)},T.checkDemoMode=function(latlng){this.checkMode("demo")&&this.demo.start(5e3,latlng)},T.outdateInterval,T.outdateChecker=function(){this.outdateInterval||(this.outdateInterval=setInterval((function(){for(var id in T.locations)T.locations[id].timestamp+T.locations[id].timeout<Date.now()&&T.map.setMarkerOpacity(T.locations[id],.4)}),6e4))},T.start=function(mapId,opts){T.options=T.update(T.options,opts),this.map=this._map(mapId),T._ui.addTo(this.map),this.map.once("locationfound",(function(e){T.checkDemoMode(e.latlng)})),this.map.once("locationerror",(function(e){T.checkDemoMode()})),this.map.locateView(),T.checkWatchMode(),this.checkWebSocket(),this.outdateChecker(),window.addEventListener("unload",T.stop)},T.stop=function(){T.locationWatcher.stop(),"webSocket"in T&&T.webSocket.close(),clearInterval(T.outdateInterval),T.noSleep.disable(),T.demo.stop(),T.map.remove()},T._map=function(mapId,latlng){var map=L.map(mapId,{zoom:17,zoomControl:!1});return L.tileLayer(window.location.protocol+"//{s}.tile.osm.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'}).addTo(map),map.isLoaded=!1,map.fitWorld({padding:[-100,-1e3]}),map.ui={},map.on("locationfound",(function(e){map.ui.consolePane.log(),map.setView(e.latlng,map.options.zoom)})),map.on("locationerror",(function(e){map.ui.consolePane.log(e.message),console.log(e.message)})),map.locateView=function(latlng){return latlng?this.setView(latlng,this.options.zoom):(this.ui.consolePane.log("Expect location...",12e4),this.locate({setView:!1})),this},map.markerLayer=L.featureGroup(),map.addLayer(map.markerLayer),map.accuracyLayer=L.featureGroup(),map.addLayer(map.accuracyLayer),map.showAccuracy=!0,map.toggleAccuracy=function(){return this.showAccuracy=!this.showAccuracy,this.showAccuracy?(map.hasLayer(this.track.accuracyLayer)||this.addLayer(this.track.accuracyLayer),this.addLayer(this.accuracyLayer)):(map.hasLayer(this.track.accuracyLayer)&&this.removeLayer(this.track.accuracyLayer),this.removeLayer(this.accuracyLayer)),this.showAccuracy},map.markers=[],map.setMarkerOpacity=function(loc,opacity){var marker=this.markers[loc.id];marker&&marker.setOpacity(opacity)},map.setMarker=function(loc,icon){icon=icon||(loc.itsme?T.icons.own:T.icons.default);var marker=this.markers[loc.id];return marker?(marker.setLatLng(loc.latlng),marker.accuracyCircle.setLatLng(loc.latlng),marker.accuracyCircle.setRadius(loc.accuracy),marker.setOpacity(1)):((marker=L.marker(loc.latlng,{icon:icon,alt:loc.id,title:loc.id})).on("click",(function(e){map.onMarkerClick(e)})),marker.addTo(this.markerLayer),marker.accuracyCircle=L.circle(loc.latlng,loc.accuracy,{weight:1,color:"blue"}).addTo(this.accuracyLayer),this.markers[loc.id]=marker),marker.location=loc,this.trackMarker(marker),marker},map.searchMarkersById=function(pattern){String.prototype.replaceAll=function(f,r){return this.split(f).join(r)},pattern="^"+pattern.replaceAll("?",".{1}").replaceAll("*",".*")+"$";var list=[];try{var rex=new RegExp(pattern,"i")}catch(e){return console.log(e.message),list}for(var key in map.markers)rex.test(key)&&(list[key]=map.markers[key]);return list},map.boundMarkers=function(){if(this.hasLayer(this.accuracyLayer))var bounds=this.accuracyLayer.getBounds();else var bounds=this.markerLayer.getBounds();this.fitBounds(bounds)},map.onMarkerClick=function(e){var id=e.target.options.alt,marker=this.markers[id];this.startTrack(marker)},map.track={marker:null,pathLayer:null,rubberThread:null,accuracyLayer:L.featureGroup(),pathLength:0,lastLocation:null},map.track.init=function(map){map.hasLayer(this.accuracyLayer)&&map.removeLayer(this.accuracyLayer),map.hasLayer(this.pathLayer)&&map.removeLayer(this.pathLayer),map.hasLayer(this.rubberThread)&&map.removeLayer(this.rubberThread),this.pathLayer=L.polyline([],{weight:2,color:"red"}).addTo(map),this.rubberThread=L.polyline([],{weight:2,color:"red"}).addTo(map),this.accuracyLayer=L.featureGroup(),map.showAccuracy&&map.addLayer(this.accuracyLayer),this.pathLength=0,this.lastLocation=void 0},map.startTrack=function(marker){this.track.marker===marker?(marker.location.itsme&&(T.noSleep.disable(),this.ui.consolePane.log("NoSleep OFF")),this.track.marker=void 0,this.track.rubberThread.setLatLngs([]),this.ui.infoPane&&this.ui.infoPane.remove()):(marker.location.itsme&&(T.noSleep.enable(),this.ui.consolePane.log("NoSleep ON")),this.track.init(this),this.track.started=marker.location.timestamp,this.ui.infoPane||this.ui.infoPaneCtl.addTo(this),this.track.marker=marker,this.trackMarker(marker))},map.trackMarker=function(marker){if(this.track.marker===marker){var dist=0,step=T.options.track.minDistance;this.track.lastLocation&&(dist=map.distance(marker.location.latlng,this.track.lastLocation.latlng),step=Math.max(step,step*T.options.track.multiplier*dist*1e3/(marker.location.timestamp-this.track.lastLocation.timestamp))),!this.track.lastLocation||dist>=step?(this.track.lastLocation=marker.location,this.track.pathLayer.addLatLng(marker.location.latlng),L.circle(marker.location.latlng,marker.accuracyCircle.getRadius(),{weight:1,color:"blue"}).addTo(this.track.accuracyLayer),this.track.pathLength+=dist,this.track.rubberThread.setLatLngs([])):this.track.rubberThread.setLatLngs([this.track.lastLocation.latlng,marker.location.latlng]),this.setView(marker.location.latlng,this.getZoom()),this.ui.infoPane.update(L.Util.extend(marker.location,{trackLength:this.track.pathLength,trackTime:marker.location.timestamp-this.track.started,movement:dist}))}},map},T._ui={infoPaneCtl:new(L.Control.extend({options:{position:"bottomleft",paneData:{table1:{title:function(d){return"Track: "+d.id},tableData:[["DST",function(d){return Math.round(d.trackLength)+" m"}],["TTM",function(d){return new Date(d.trackTime).toISOString().substring(11,19)}]]},table2:{title:"Location:",tableData:[["TME",function(d){return new Date(d.timestamp).toISOString().substring(11,19)}],["SPD",function(d){return Math.round(d.speed)+" m/s"}],["ALT",function(d){return Math.round(d.altitude)+" m"}],["MVT",function(d){return Math.round(d.movement)+" m"}],["HDN",function(d){return Math.round(d.heading)+" m"}],["ACC",function(d){return Math.round(d.accuracy)+" m"}]]}},updateData:[]},onAdd:function(map){var pane=L.DomUtil.create("div","tracker-pane");pane.onclick=function(e){var pane=map.ui.infoPane.getContainer();pane.style.marginLeft?pane.style.marginLeft="":pane.style.marginLeft="-100px"};var uData=this.options.updateData,setValue=function(el,value){"function"==typeof value?uData.push([el,value]):el.innerHTML=value},table,tbl,row;for(var key in this.options.paneData){setValue(L.DomUtil.create("div","tracker-title",pane),this.options.paneData[key].title);var table=this.options.paneData[key].tableData;tbl=L.DomUtil.create("table","tracker-table",pane);for(var i=0;i<table.length;i++)row=L.DomUtil.create("tr","tracker-row",tbl),setValue(L.DomUtil.create("td","tracker-info-nick",row),table[i][0]),setValue(L.DomUtil.create("td","tracker-info-value",row),table[i][1])}return map.ui.infoPane=this,L.DomEvent.disableClickPropagation(pane),L.DomEvent.disableScrollPropagation(pane),pane},onRemove:function(map){delete map.ui.infoPane},update:function(info){for(var uData=this.options.updateData,i=0;i<uData.length;i++)uData[i][0].innerHTML=uData[i][1](info)}})),consolePaneCtl:new(L.Control.extend({options:{position:"bottomright",timer:null},onAdd:function(map){var pane=L.DomUtil.create("div","tracker-console");return pane.hidden=!0,map.ui.consolePane=this,pane},onRemove:function(map){delete map.ui.consolePane},log:function(m,timeout){var pane=this.getContainer();m?(pane.innerHTML=(new Date).toTimeString().substring(0,8)+" "+m,pane.hidden=!1,timeout=timeout||1e4,this.options.timer&&clearTimeout(this.options.timer),this.options.timer=setTimeout((function(t){t.getContainer().hidden=!0,t.options.timer=null}),timeout,this)):pane.hidden=!0}})),listPaneCtl:new(L.Control.extend({options:{position:"topright"},onAdd:function(map){var pane=L.DomUtil.create("div","tracker-pane"),tbl,row,el,list=map.listOfFound;pane.onclick=function(e){if("img"===e.target.tagName.toLowerCase()){var markerId=e.target.parentNode.parentNode.childNodes[2].innerHTML,marker=map.markers[markerId];map.track.marker===marker?map.setView(marker.getLatLng(),map.options.zoom):map.startTrack(map.markers[markerId])}map.ui.listPane.remove()};var title=L.DomUtil.create("div","tracker-title",pane),scrollDiv=L.DomUtil.create("div","tracker-scroll",pane),scrollHeight=function(el,dh){var newHeight=(window.innerHeight||document.documentElement.clientHeight)-105+"px";newHeight!==el.style.maxHeight&&(el.style.maxHeight=newHeight)};scrollHeight(scrollDiv,110),this.options.interval=setInterval(scrollHeight,500,scrollDiv,105),tbl=L.DomUtil.create("table","tracker-list",scrollDiv);var imgStyle=T.touchScreen?"tracker-button":"tracker-list",i=0;for(var key in list){var img;row=L.DomUtil.create("tr","tracker-list",tbl),el=L.DomUtil.create("td","tracker-list-img",row),L.DomUtil.create("img",imgStyle,el).src=list[key].getIcon().options.iconUrl,i++,(el=L.DomUtil.create("td","tracker-list",row)).innerHTML=i.toString()+(map.track.marker===list[key]?"*":""),(el=L.DomUtil.create("td","tracker-list-id",row)).innerHTML=key}return title.innerHTML="Found: "+i,map.ui.listPane=this,L.DomEvent.disableClickPropagation(pane),L.DomEvent.disableScrollPropagation(pane),pane},onRemove:function(map){delete map.ui.listPane,clearInterval(this.options.interval)}})),buttonPaneCtl:new(L.Control.extend({options:{position:"topright",buttons:{btnSearch:{img:"./images/btn_search.png",onclick:function(map){return function(e){var frm=this.childNodes[0];if("form"!==frm.tagName.toLowerCase()){(frm=L.DomUtil.create("form","tracker-search")).style.display="none";var inp=L.DomUtil.create("input","tracker-search",frm);inp.type="text",inp.name="searchCriteria",inp.autocomplete="on",frm.onsubmit=function(){"listPane"in map.ui&&map.ui.listPane.remove();try{map.listOfFound=map.searchMarkersById(inp.value),0!==Object.keys(map.listOfFound).length?map.ui.listPaneCtl.addTo(map):inp.value&&map.ui.consolePane.log("Nothing found")}catch(e){console.log(e.message)}return this.style.display="none",!1},this.insertBefore(frm,e.target)}"img"!==e.target.tagName.toLowerCase()||frm.style.display?(frm.style.display="",frm.searchCriteria.focus(),frm.searchCriteria.scrollIntoView()):frm.onsubmit(frm)}}},btnAccuracy:{img:"./images/btn_accuracy.png",onclick:function(map){return function(e){this.childNodes[1].hidden=!map.toggleAccuracy()}},checkerImg:"./images/btn_checker.png",checked:!0},btnBound:{img:"./images/btn_bound.png",onclick:function(map){return function(e){map.boundMarkers()}}},btnLocate:{img:"./images/btn_locate.png",onclick:function(map){return function(e){map.locateView()}}}}},onAdd:function(map){var pane=L.DomUtil.create("div","tracker-buttons-pane"),img,btn,chk;for(var key in this.options.buttons)btn=L.DomUtil.create("div","tracker-button",pane),(img=L.DomUtil.create("img","tracker-button",btn)).src=this.options.buttons[key].img,this.options.buttons[key].onclick&&(btn.onclick=this.options.buttons[key].onclick(map)),"checked"in this.options.buttons[key]&&((chk=L.DomUtil.create("img","tracker-button-checker",btn)).src=this.options.buttons[key].checkerImg,chk.hidden=!this.options.buttons[key].checked);return map.ui.buttonPane=this,L.DomEvent.disableClickPropagation(pane),L.DomEvent.disableScrollPropagation(pane),pane},onRemove:function(map){delete map.ui.buttonPane}})),addTo:function(map){return this.buttonPaneCtl.addTo(map),this.consolePaneCtl.addTo(map),map.ui.infoPaneCtl=this.infoPaneCtl,map.ui.listPaneCtl=this.listPaneCtl,map}},T.demo={isRunning:!1,demos:[],randInt:function(minInt,maxInt){return minInt===maxInt?minInt:Math.floor(Math.random()*(maxInt-minInt+1)+minInt)},randDbl:function(minDbl,maxDbl){return minDbl===maxDbl?minDbl:Math.random()*(maxDbl-minDbl)+minDbl},radialDistance:function(latlng,heading,distance){var R=6371010,d=distance,RpD=Math.PI/180,brng=heading%360*RpD,φ1=latlng.lat*RpD,λ1=latlng.lng*RpD,φ2=Math.asin(Math.sin(φ1)*Math.cos(d/R)+Math.cos(φ1)*Math.sin(d/R)*Math.cos(brng)),λ2;return{lat:φ2/RpD,lng:((λ1+Math.atan2(Math.sin(brng)*Math.sin(d/R)*Math.cos(φ1),Math.cos(d/R)-Math.sin(φ1)*Math.sin(φ2)))/RpD+540)%360-180}},moveRandom:function(p){p.heading=(this.randInt(p.heading-45,p.heading+45)+360)%360;var dst=this.randDbl(10,50);return p.latlng=this.radialDistance(p.latlng,p.heading,dst),p.speed=dst/((Date.now()-p.timestamp)/1e3),p.accuracy=this.randDbl(5,50),p.timestamp=Date.now(),p},sendAllDemos:function(){for(var i=0;i<this.demos.length;i++)this.sendDemo(this.moveRandom(this.demos[i]))},sendDemo:function(d){T.onJSONMessage(JSON.stringify(d))},start:function(delay,latlng){if(!this.isRunning){this.isRunning=!0;for(var i=0;i<30;i++){var p=new T.Location;p.action="location",p.id="Demo "+(i+1),p.timeout=delay,p.latlng=latlng||L.latLng(51.505,-.09),p.heading=this.randInt(0,360),this.demos[i]=this.moveRandom(p)}this.sendAllDemos(),this.interval=setInterval((function(d){d.sendAllDemos()}),delay,this),T.onJSONMessage(JSON.stringify({action:"message",message:"DEMO started"}))}},stop:function(){this.interval&&clearInterval(this.interval)}}}(window,document);